name: Security Scan

on:
  pull_request:
    branches:
      - main
    paths:
      - '**/*.tf'

jobs:
  tfsec:
    name: tfsec Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find modified modules
        id: modules
        run: |
          # Get changed .tf files in this PR
          CHANGED_FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only | grep '\.tf$' || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No .tf files changed"
            echo "dirs=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract unique module directories
          DIRS=$(echo "$CHANGED_FILES" | xargs -I {} dirname {} | sort -u | tr '\n' ' ')
          echo "Modified module directories: $DIRS"
          echo "dirs=$DIRS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Run tfsec
        if: steps.modules.outputs.dirs != ''
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: .
          soft_fail: false
          format: lovely
          additional_args: --minimum-severity HIGH

      - name: Run tfsec with SARIF output
        if: steps.modules.outputs.dirs != '' && always()
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: .
          soft_fail: true
          format: sarif
          additional_args: --out results.sarif

      - name: Upload SARIF file
        if: steps.modules.outputs.dirs != '' && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        continue-on-error: true

      - name: Post summary comment
        if: steps.modules.outputs.dirs != '' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ”’ Security Scan Failed\n\ntfsec found security issues with **HIGH** or **CRITICAL** severity.\n\nPlease review the workflow logs and fix the issues before merging.\n\n[View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
            })
