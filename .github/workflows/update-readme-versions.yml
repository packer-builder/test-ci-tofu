name: Update README Versions

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to update READMEs to (e.g., v1.9.0)'
        required: true
        type: string
      modules:
        description: 'Space-separated module paths to update (leave empty for all modules)'
        required: false
        type: string
        default: ''

jobs:
  update-versions:
    name: Update Module README Versions
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Find modules to update
        id: modules
        run: |
          if [ -n "${{ inputs.modules }}" ]; then
            # Use specified modules
            DIRS="${{ inputs.modules }}"
          else
            # Find all module directories with READMEs
            DIRS=$(find infrastructure -name "README.md" -exec dirname {} \; | sort -u | tr '\n' ' ')
          fi
          echo "Module directories: $DIRS"
          echo "dirs=$DIRS" >> $GITHUB_OUTPUT

      - name: Update README versions
        run: |
          NEW_VERSION="${{ inputs.version }}"
          DIRS="${{ steps.modules.outputs.dirs }}"

          echo "Updating READMEs to version: $NEW_VERSION"

          for dir in $DIRS; do
            README="$dir/README.md"
            if [ -f "$README" ]; then
              if grep -q "ref=v" "$README"; then
                echo "Updating $README"
                sed -i "s/ref=v[0-9]*\.[0-9]*\.[0-9]*/ref=$NEW_VERSION/g" "$README"
              fi
            fi
          done

      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add infrastructure/*/README.md infrastructure/*/*/README.md 2>/dev/null || true

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: update module READMEs to ${{ inputs.version }} [skip ci]"
            git push
          fi
        env:
          HUSKY: 0
