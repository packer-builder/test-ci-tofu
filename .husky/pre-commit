#!/bin/sh

# Validate branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)
PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)/.+$"

if [ "$BRANCH" != "main" ] && ! echo "$BRANCH" | grep -Eq "$PATTERN"; then
  echo "Invalid branch name: $BRANCH"
  echo ""
  echo "Branch name must follow the pattern: type/description"
  echo "  Examples: feat/add-login, fix/bug-123, docs/readme"
  echo ""
  echo "Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
  exit 1
fi

# Find all directories containing .tf files
dirs=$(find . -name "*.tf" -not -path "./.terraform/*" -exec dirname {} \; | sort -u)

# Check formatting
echo "Checking format..."
if ! tofu fmt -check -recursive > /dev/null 2>&1; then
  echo "Format check failed. Run 'tofu fmt -recursive' to fix."
  exit 1
fi

# Validate each module
for dir in $dirs; do
  echo "Validating $dir..."

  # Initialize if needed (without backend)
  if [ ! -d "$dir/.terraform" ]; then
    tofu -chdir="$dir" init -backend=false > /dev/null 2>&1
  fi

  # Validate
  if ! tofu -chdir="$dir" validate; then
    echo "Validation failed in $dir"
    exit 1
  fi
done

echo "All modules validated successfully"

# Run tfsec security scan on staged .tf files
if command -v tfsec &> /dev/null; then
  staged_tf=$(git diff --cached --name-only --diff-filter=ACM | grep '\.tf$' || true)

  if [ -n "$staged_tf" ]; then
    staged_dirs=$(echo "$staged_tf" | xargs -I {} dirname {} | sort -u)

    echo "Running tfsec security scan..."
    for dir in $staged_dirs; do
      if ! tfsec "$dir" --minimum-severity HIGH --concise-output; then
        echo ""
        echo "Security issues found in $dir"
        echo "Fix the issues or use 'git commit --no-verify' to skip"
        exit 1
      fi
    done
    echo "Security scan passed"
  fi
else
  echo "tfsec not installed, skipping security scan (install: brew install tfsec)"
fi
